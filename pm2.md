# pm2 的学习

# question

1. 如何实现负载均衡的会话一致性？(pm2有实现会话一致性吗？这个问题暂时不一定算在pm2中)
2. round-robin 实际上是网络的负载均衡，真的是cpu的负载均衡吗？需要参考nginx的负载均衡实现。
对nginx来说它的负载均衡也是对网络请求的负载均衡。但是不确定它是怎么样给出权重（自己获取还是要设置）

## 对 pm2 和相关知识的整理和介绍


### pm2是什么呢？pm2是一个node.js的管理器，负责node.js程序的重启和负载均衡。

    - 官方的说法：pm2 是具有内置负载平衡器的 nod​​e.js 应用程序的生产过程管理器。它允许您保持应用程序永久存活，
    无需停机即可重新加载应用程序，并便于执行常见的系统管理任务。
    - 自己的理解：让你的node.js程序永远运行，而且达到负载均衡（cpu等方面）





## 有疑问的知识点

- 对pm2来说当程序出错了，它会做什么？

    ```js
    console.log('pm2 shut down test');

    setTimeout(() => {
      process.exit();
    }, 1000);
    ```

    用上面的这段代码测试了一下。发现pm2会在程序死亡后一直重启程序。而且pm2的monitor显示pm2的确会试图去降低cpu的负载



- 对node.js来说，或者对操作系统来说。负载意味着什么？(下面的回答来自饿了吗的node)

    负载是衡量服务器运行状态的一个重要概念. 通过负载情况, 我们可以知道服务器目前状态是清闲, 良好, 繁忙还是即将 crash.
    通常我们要查看的负载是 CPU 负载, 详细一点的情况你可以通过阅读这篇博客: Understanding Linux CPU Load 来了解
    (这篇博文很重要，解释了负载的意义和使用负载的方法).

    命令行上可以通过 uptime, top 命令, Node.js 中可以通过 os.loadavg() 来获取当前系统的负载情况:

    ```text
        load average: 0.09, 0.05, 0.01
    ```
    其中分别是最近 1 分钟, 5 分钟, 15 分钟内系统 CPU 的平均负载. 当 CPU 的一个核工作饱和的时候负载为 1, 有几核 CPU 那么饱和负载就是几.
    对1来说，0.7是安全的值。
    在 Node.js 中单个进程的 CPU 负载查看可以使用 pidusage 模块.
    除了 CPU 负载, 对于服务端 (偏维护) 还需要了解网络负载, 磁盘负载等.


- pm2的大致工作原理？

    要想明白pm2的工作原理，需要理解node的cluster模块的master-worker模型。当了解了master-worker的基本方式后，就明白的pm2的大致工作原理
    当实现了启动多个worker进程后。如果在worker死亡时重新启动呢？其实只需要在master进程中，监听worker的exit事件。当exit的时候重新启动一个worker
    当起了多个worker过后要实现对请求的转发实质上就是使用了一个网络的代理。将发送给master的转发给worker。将worker的返回转发给client。
    
    

- pm2是如何实现负载的均衡的？

    负载均衡的实现就是将请求代理实现负载均衡。用的是round-robin算法。
    
- pm2的守护进程是如何实现的？
